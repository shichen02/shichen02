---
title: 一种内网穿透的实现思路
categories: [运维]
---
## 背景
最近有这样一个需求，外部网络可以完全访问内网的所有资源。之前采用的有这样几种方案
一、 内网穿透：将要访问的内网主机穿透到公网上面。举个例子，比如我要访问一个内网的服务，他的主机IP地址是172.16.2.88,端口是8080。现在利用公网穿透技术，将这个服务穿透到公网IP是48.230:103.123 端口为 12320 上面。外网主机就可以直接通过访问 48.230.103.123:12320 去对内网主机发起访问。 
二、VPN虚拟专用网络：通过软件架起一个虚拟的专线访问内网主机，这是目前主流的方案。但是一般要配合网管在防火墙或者路由器安装特定软件。
三、异地组网：通过某些软件产品，只要能够访问公网，就可以搭建一个虚拟的局域网实现访问。
四、socks5 协议：socks5 协议设计之初，就是提供一种可以绕过防火墙访问内网的技术，只要在防火墙开一个口子，就能通过这个口子，访问内网资源。
上面的各种方案，慢慢都不能满足日常的需求，于是我决定自己开发一个，简易软件，满足的自己使用。
## 软件特性
经过日常的总结，软件应该满足下面的特性：
核心需求：

- 外部网络可以完全访问内网的所有资源
- 无需复杂的配置，用户开箱即用
- 可以进行访问控制

次需求

- 可以进行流量加密
- 可以进行流量混淆，不容易被识别特征
## 设计思路
经过查询发现 socks5 协议协议简单， 能够转发传输层的所有流量，所以打算是通过 socks5 协议来实现内网访问，下面介绍实现思路，软件采用 client-server 架构，client 处于内网，server 处于公网。
1、通过 client 主动向 server 建立链接通道。这样访问 server 就可以利用该通道直接访问 client 。
2、client 上用一个 socks5 协议的处理器，通过之前的通道，就可以代理访问内网资源了。


![img](https://chengdumarkdown.oss-cn-chengdu.aliyuncs.com/blog/1694008809964-b139e66c-6584-4cc1-89c0-179c44a63322.svg)

图一、介绍了软件的工作流程，其实核心思路就是通过一个内网的主机 client 请求一个具有公网IP地址的server 保持一个长连接， 从而转发请求。绕过了防火墙，直接请求 client 的 socks5 处理器。让 client 充当代理人的角色，server 更类似一个中继站。
client 到 server 之间关系，其实就非常类似内网穿透。

## 最终实现
软件的核心模块分为三个部分
### 一、socks5
socks 5 协议解析采用开源软件库的的 sockslib ，来解析并处理请求
### 二、中继服务器
需要有一台能够在公网直接访问的服务器作为中继，来转发流量。
### 三、安全性
为了让流量在公网转发时候不被窃取，可以采用加密技术，如使用 TLS 通道。由于client 和 server 都由用户自己部署，不存在密钥分发的问题，我为了方便实现采用 256 位的 AES 流式对称加密，来保护转发通道的通信。但是注意，为了保持兼容性，用户到转发服务器之间的流量，并未采用自定义协议来保护，而是 socks5 明文。
### 四、本地镜像
使用 Graalvm 来编译本地镜像或者 jpackage 打包，这样用户就无需安装 jre 环境，开箱即用
## 软件发布版

## 软件使用
####  1、安装环境
 以客户模式启动
```shell
socks5 client
```
以服务端模式启动
```shell
socks5 server
```
#### 2、用户端配置
一、可以直接在操作系统配置 socks5 代理。
以 mac 系统为例
![image.png](https://chengdumarkdown.oss-cn-chengdu.aliyuncs.com/blog/1695290147655-590bce36-a9f5-448c-b368-8c7832facbf4.png)
设置—网络—代理—socks 代理即可配置
二、使用浏览器插件
使用 chrome 插件 SwitchyOmega 
![image.png](https://chengdumarkdown.oss-cn-chengdu.aliyuncs.com/blog/1695290344236-03d9fa9e-3e98-4e32-bfc1-862dbb9bdc8e.png)
协议选择 socks5 ，直接配置服务器和端口即可使用
